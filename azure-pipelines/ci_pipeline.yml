trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  dockerRegistryServiceConnection: 'DOCKER-CONNECTION-NAME'
  imageRepository: 'mlp-api'
  containerRegistry: 'tonusername.azurecr.io'
  dockerfilePath: '**/Dockerfile'
  tag: 'latest'

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.10'

- script: |
    python -m venv venv
    source venv/bin/activate
    pip install -r requirements.txt
    python -m unittest discover -s tests
  displayName: 'Run Unit Tests'

- task: Docker@2
  inputs:
    command: buildAndPush
    repository: $(imageRepository)
    dockerfile: $(dockerfilePath)
    containerRegistry: $(dockerRegistryServiceConnection)
    tags: |
      $(tag)
  displayName: 'Build and Push Docker Image'
